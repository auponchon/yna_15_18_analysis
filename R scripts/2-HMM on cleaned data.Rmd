---
title: "HMM on cleaned data"
author: "Aurore Ponchon"
date: "16/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning=FALSE,message=FALSE)
```

## Fitting a HMM for each year

First step is to test different sets of parameters for length steps and angles. 
The code is commented so that it does not run but can be reproducible with the set.seed.
Best set of parameters are determined based on the highest negative lihelihood.

### Fitting a HMM on 2015 data

```{r HMM test 2015, eval=F}
load("Data/NewlyCreatedData/clean_interp_loc_day_2015.RData")

library(moveHMM)

essai.2015<-loc.interpolated.2015
#get a travelID by day
essai.2015$ID<-paste(essai.2015$TravelID,
                           strftime(loc.interpolated.2015$DateTime, "%d", tz="UTC"),
                           sep=".")

proc.essai<-prepData(essai.2015,type="LL",
                     coordNames=c("Longitude","Latitude")) #step in km if LL, m if UTM

par(mdrow=c(1,2))
hist(proc.essai$step)
hist(proc.essai$angle)

#fiding the right set of parameters for step length and turning angles  for 3 states
 set.seed(12345)
 nruns<-25
 mles<-vector("numeric",length=nruns)

 #test for von mise distribution for angle concentrations
for (foo in 1:nruns){
  print(foo)
  mu0<-sort(c(runif(1,0.3,10),runif(1,1,20),runif(1,5,30)) ) # means for step length
  sigma0<-c(runif(1,0.3,10),runif(1,0.3,30),runif(1,0.3,10))  #sd for step length
  zeromass0<-runif(3,0,0.01)
  stepPar0<-c(mu0,sigma0,zeromass0)  #joint object for step length
  angleMean0<-sample(c(0,pi),size=3,replace=T)   #mean for turning angle
  kappa0<-runif(3,0,5)  # angle concentration
  anglePar0<-c(angleMean0,kappa0)

  print(c(stepPar0,anglePar0))

  m0<-fitHMM(data=proc.essai,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
             formula=~1,angleDist="vm")
  mles[foo]<--m0$mod$minimum

  print( mles[foo])
}

table(round(mles))

#lowest likelihood: -9345 with wrpcauchy
#parameters: 

 #test for wrapped cauchy for angle concentrations
for (foo in 1:nruns){
  print(foo)
  mu0<-sort(c(runif(1,0.3,10),runif(1,1,20),runif(1,5,30)) ) # means for step length
  sigma0<-c(runif(1,0.3,10),runif(1,0.3,30),runif(1,0.3,10))  #sd for step length
  zeromass0<-runif(3,0,0.01)
  stepPar0<-c(mu0,sigma0,zeromass0)  #joint object for step length
  angleMean0<-sample(c(0,pi),size=3,replace=T)   #mean for turning angle
  kappa0<-runif(3,0,5)  # angle concentration
  anglePar0<-c(angleMean0,kappa0)

  print(c(stepPar0,anglePar0))

  m0<-fitHMM(data=proc.essai,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
             formula=~1,angleDist="wrpcauchy")
  mles[foo]<--m0$mod$minimum

  print( mles[foo])
}

table(round(mles))
#lowest likelihood: -9595.762 with wrpcauchy
#parameters: 
```

After testing different sets of parameters and comparing how von mises and wrapcauchy, we take the ones that give the lowest likelihood to run the final model 

```{r final HMM 2015}
#Test with best paramaters with wrpcauchy angle distributions
mu0<-c(3,6.5,6.8)  
sigma0<-c(9.6,22,5)  
zeromass0<-c(0.0088,0.0058,0.0069) 
stepPar0<-c(mu0,sigma0,zeromass0) 
angleMean0<-c(3.14,0,0)  
kappa0<-c(0.18,0.16,0.48)  
anglePar0<-c(angleMean0,kappa0)
finmodWPC<-fitHMM(data=proc.essai,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
           formula=~1,angleDist="wrpcauchy")

 res<-pseudoRes(finmodWPC)
 par(mfrow=c(1,2))
hist(res$stepRes)
hist(res$angle)
 
plotPR(finmodWPC)
AIC(finmodWPC)

loc.interpolated.2015$States<-viterbi(finmodWPC)

#delimit hours falling into duty cycle on (5am to 22pm UTM)
duty.off<-c('5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21') 
loc.interpolated.day.2015 <- subset(loc.interpolated.2015,
                                strftime(loc.interpolated.2015$DateTime, "%H", tz="UTC") %in% duty.off)

save(loc.interpolated.2015,file="Data/NewlyCreatedData/loc_interpolated_states_2015.RData")
save(loc.interpolated.day.2015,file="Data/NewlyCreatedData/loc_interpolated_states_day_2015.RData")
```

### Fitting HMM on 2018 data

```{r HMM test 2018, eval=F}
load("Data/NewlyCreatedData/clean_interp_loc_day_2018.RData")


essai.2018<-loc.interpolated.2018
#get a travelID by day
essai.2018$ID<-paste(essai.2018$TravelID,
                           strftime(loc.interpolated.2018$DateTime, "%d", tz="UTC"),
                           sep=".")

proc.essai<-prepData(essai.2018,type="LL",
                     coordNames=c("Longitude","Latitude")) #step in km if LL, m if UTM

par(mfrow=c(1,2))
hist(proc.essai$step)
hist(proc.essai$angle)

#fiding the right set of parameters for step length and turning angles  for 3 states
 set.seed(12345)
#  nruns<-25
#  mles<-vector("numeric",length=nruns)
# 
# for (foo in 1:nruns){
#   print(foo)
#   mu0<-sort(c(runif(1,0.3,10),runif(1,1,20),runif(1,5,30)) ) # means for step length
#   sigma0<-c(runif(1,0.3,10),runif(1,0.3,30),runif(1,0.3,10))  #sd for step length
#   zeromass0<-runif(3,0,0.01)
#   stepPar0<-c(mu0,sigma0,zeromass0)  #joint object for step length
#   angleMean0<-sample(c(0,pi),size=3,replace=T)   #mean for turning angle
#   kappa0<-runif(3,0,5)  # angle concentration
#   anglePar0<-c(angleMean0,kappa0)
# 
#   print(c(stepPar0,anglePar0))
# 
#   m0<-fitHMM(data=proc.essai,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
#              formula=~1,angleDist="vm")
#   mles[foo]<--m0$mod$minimum
# 
#   print( mles[foo])
# }
# 
# table(round(mles))

#lowest likelihood: -9345 with wrpcauchy
#parameters: 

#lowest likelihood: -9595.762 with vm
```

After testing different sets of parameters and comparing how von mises and wrapcauchy, we take the ones that give the lowest likelihood to 
run the final model 

```{r final HMM}
#Test with best paramaters with wrpcauchy angle distributions
mu0<-c(3,6.5,6.8)  
sigma0<-c(9.6,22,5)  
zeromass0<-c(0.0088,0.0058,0.0069) 
stepPar0<-c(mu0,sigma0,zeromass0) 
angleMean0<-c(3.14,0,0)  
kappa0<-c(0.18,0.16,0.48)  
anglePar0<-c(angleMean0,kappa0)
finmodWPC<-fitHMM(data=proc.essai,nbStates=3,stepPar0=stepPar0,anglePar0=anglePar0,
           formula=~1,angleDist="wrpcauchy")

 res<-pseudoRes(finmodWPC)
 par(mfrow=c(1,2))
hist(res$stepRes)
hist(res$angle)
 
plotPR(finmodWPC)
AIC(finmodWPC)

loc.interpolated.2018$States<-viterbi(finmodWPC)

#delimit hours falling into duty cycle on (5am to 22pm UTM)
duty.off<-c('5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21') 
loc.interpolated.day.2018 <- subset(loc.interpolated.2018,
                                strftime(loc.interpolated.2018$DateTime, "%H", tz="UTC") %in% duty.off)

save(loc.interpolated.2018,file="Data/NewlyCreatedData/loc_interpolated_states_2018.RData")
save(loc.interpolated.day.2018,file="Data/NewlyCreatedData/loc_interpolated_states_day_2018.RData")
```




