---
title: "3-Kernels"
author: "Aurore Ponchon"
date: "20/10/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,message=FALSE, warning=FALSE)
```

## Extracting locations and paths for each selected trip for 2015

Paths are extracted based on all interpolated trips including night time data. On the contrary, points are extracted based on data for daylight only.

```{r paths and points 2015}
load("Data/NewlyCreatedData/loc_interpolated_states_2015.RData")
load("Data/NewlyCreatedData/loc_interpolated_states_day_2015.RData")

library(fields)
library(adehabitatHR)
library(maptools)
library(rgdal)
library(raster)
library(sf)

#subset data for failed and successful breeders to plot paths
loc.yna.fail.2015<-subset(loc.interpolated.2015,loc.interpolated.2015$Status=="fail")
loc.yna.suc.2015<-subset(loc.interpolated.2015,loc.interpolated.2015$Status=="success")

#create shapefiles paths
sf_locs <- sf::st_as_sf(loc.yna.fail.2015, coords = c("Longitude","Latitude")) %>% 
  sf::st_set_crs(4326)

sf_lines <- sf_locs %>%
  dplyr::arrange(ID, DateTime) %>%
  sf::st_geometry() %>%
  sf::st_cast("MULTIPOINT",ids = as.integer(as.factor(sf_locs$ID))) %>%
  sf::st_cast("MULTILINESTRING") %>%
  sf::st_sf(ID = as.factor(unique(sf_locs$ID)))

st_write(sf_lines,layer="Line_fail_2015",dsn="Data/NewlyCreatedData/Shapefiles",
         driver="ESRI Shapefile", delete_layer = TRUE,update=T)

sf_locs <- sf::st_as_sf(loc.yna.suc.2015, coords = c("Longitude","Latitude")) %>% 
  sf::st_set_crs(4326)

sf_lines <- sf_locs %>%
  dplyr::arrange(ID, DateTime) %>%
  sf::st_geometry() %>%
  sf::st_cast("MULTIPOINT",ids = as.integer(as.factor(sf_locs$ID))) %>%
  sf::st_cast("MULTILINESTRING") %>%
  sf::st_sf(ID = as.factor(unique(sf_locs$ID)))

st_write(sf_lines,layer="Line_success_2015",dsn="Data/NewlyCreatedData/Shapefiles",
driver="ESRI Shapefile", delete_layer = TRUE,update=T)

#subset data for failed and successful breeders for locations
loc.fail.day.2015<-subset(loc.interpolated.day.2015,loc.interpolated.day.2015$Status=="fail")
droplevels(loc.fail.day.2015)
coordinates(loc.fail.day.2015)<-c("Longitude","Latitude")
proj4string(loc.fail.day.2015) <- CRS("+proj=longlat +ellps=WGS84")
loc.fail.day.2015<-spTransform(loc.fail.day.2015, CRS("+proj=utm +zone=45 +ellps=WGS84"))
writeOGR(loc.fail.day.2015, dsn="Data/NewlyCreatedData/Shapefiles",
         layer="Locations_failed_behav_day_2015", driver="ESRI Shapefile",overwrite_layer=T)

loc.suc.day.2015<-subset(loc.interpolated.day.2015,loc.interpolated.day.2015$Status=="success")
droplevels(loc.suc.day.2015)
coordinates(loc.suc.day.2015)<-c("Longitude","Latitude")
proj4string(loc.suc.day.2015) <- CRS("+proj=longlat +ellps=WGS84")
loc.suc.day.2015<-spTransform(loc.suc.day.2015, CRS("+proj=utm +zone=45 +ellps=WGS84"))

writeOGR(loc.suc.day.2015, dsn="Data/NewlyCreatedData/Shapefiles",
         layer="Locations_success_behav_day_2015", driver="ESRI Shapefile",overwrite_layer=T)
```

## Calculation UD kernels for each group in 2015

Smoothing factor ***h*** is fixed and common to all groups both in 2015 and 2018.

```{r kernels 2015}
loc.2015<-loc.interpolated.day.2015[loc.interpolated.day.2015$States=="1"|
                                       loc.interpolated.day.2015$States=="2",]

coordinates(loc.2015)<-c("Longitude","Latitude")
proj4string(loc.2015) <- CRS("+proj=longlat +ellps=WGS84")
loc.2015<-spTransform(loc.2015, CRS("+proj=utm +zone=45 +ellps=WGS84"))

 KUD<- kernelUD(loc.2015[,2],same4all=T,h=70000,grid=1000)
    KUDvol <- getvolumeUD(KUD)
    ver90<-getverticeshr(KUDvol ,90)
    ver50<-getverticeshr(KUDvol ,50)

    # 
    writeOGR(ver90, dsn="Data/NewlyCreatedData/Shapefiles",
             layer="KUD_90_day_for", driver="ESRI Shapefile",overwrite_layer=T)
    writeOGR(ver50, dsn="Data/NewlyCreatedData/Shapefiles",
             layer="KUD_50_day_for", driver="ESRI Shapefile",overwrite_layer=T)
```

## Extracting locations and paths for each selected trip for 2018

```{r paths and points 2018}
load("Data/NewlyCreatedData/loc_interpolated_states_2018.RData")
load("Data/NewlyCreatedData/loc_interpolated_states_day_2018.RData")

#subset data for failed and successful breeders to plot paths
loc.yna.fail<-subset(loc.interpolated.2018,loc.interpolated.2018$Status=="fail")
loc.yna.suc<-subset(loc.interpolated.2018,loc.interpolated.2018$Status=="success")

#create shapefiles paths
sf_locs <- sf::st_as_sf(loc.yna.fail, coords = c("Longitude","Latitude")) %>% 
  sf::st_set_crs(4326)

sf_lines <- sf_locs %>%
  dplyr::arrange(ID, DateTime) %>%
  sf::st_geometry() %>%
  sf::st_cast("MULTIPOINT",ids = as.integer(as.factor(sf_locs$ID))) %>%
  sf::st_cast("MULTILINESTRING") %>%
  sf::st_sf(ID = as.factor(unique(sf_locs$ID)))

st_write(sf_lines,layer="Line_fail_2018",dsn="Data/NewlyCreatedData/Shapefiles",
         driver="ESRI Shapefile", delete_layer = TRUE,update=T)

sf_locs <- sf::st_as_sf(loc.yna.suc, coords = c("Longitude","Latitude")) %>% 
  sf::st_set_crs(4326)

sf_lines <- sf_locs %>%
  dplyr::arrange(ID, DateTime) %>%
  sf::st_geometry() %>%
  sf::st_cast("MULTIPOINT",ids = as.integer(as.factor(sf_locs$ID))) %>%
  sf::st_cast("MULTILINESTRING") %>%
  sf::st_sf(ID = as.factor(unique(sf_locs$ID)))

st_write(sf_lines,layer="Line_success_2018",dsn="Data/NewlyCreatedData/Shapefiles",
driver="ESRI Shapefile", delete_layer = TRUE,update=T)

#subset data for failed and successful breeders for locations
loc.yna.fail.day<-subset(loc.interpolated.day.2018,loc.interpolated.day.2018$Status=="fail")
droplevels(loc.yna.fail.day)
coordinates(loc.yna.fail.day)<-c("Longitude","Latitude")
proj4string(loc.yna.fail.day) <- CRS("+proj=longlat +ellps=WGS84")
loc.yna.fail.day<-spTransform(loc.yna.fail.day, CRS("+proj=utm +zone=45 +ellps=WGS84"))
writeOGR(loc.yna.fail.day, dsn="Data/NewlyCreatedData/Shapefiles",
         layer="Locations_failed_behav_day_2018", driver="ESRI Shapefile",overwrite_layer=T)

loc.yna.suc.day<-subset(loc.interpolated.day.2018,loc.interpolated.day.2018$Status=="success")
droplevels(loc.yna.suc.day)
coordinates(loc.yna.suc.day)<-c("Longitude","Latitude")
proj4string(loc.yna.suc.day) <- CRS("+proj=longlat +ellps=WGS84")
loc.yna.suc.day<-spTransform(loc.yna.suc.day, CRS("+proj=utm +zone=45 +ellps=WGS84"))

writeOGR(loc.yna.suc.day, dsn="Data/NewlyCreatedData/Shapefiles",
         layer="Locations_success_behav_day_2018", driver="ESRI Shapefile",overwrite_layer=T)
```

## Calculating UD kernels for each group in 2018

Smoothing factor ***h*** is fixed and common to all groups both in 2015 and 2018.

```{r kernels 20185}

loc.2018<-loc.interpolated.day.2018[loc.interpolated.day.2018$States=="1"|
                                       loc.interpolated.day.2018$States=="2",]

coordinates(loc.2018)<-c("Longitude","Latitude")
proj4string(loc.2018) <- CRS("+proj=longlat +ellps=WGS84")
loc.2018<-spTransform(loc.2018, CRS("+proj=utm +zone=45 +ellps=WGS84"))

 KUD<- kernelUD(loc.2018[,2],same4all=T,h=70000,grid=1000)
    KUDvol <- getvolumeUD(KUD)
    ver90<-getverticeshr(KUDvol ,90)
    ver50<-getverticeshr(KUDvol ,50)

    writeOGR(ver90, dsn="Data/NewlyCreatedData/Shapefiles",
             layer="KUD_90_day_for", driver="ESRI Shapefile",overwrite_layer=T)
    writeOGR(ver50, dsn="Data/NewlyCreatedData/Shapefiles",
             layer="KUD_50_day_for", driver="ESRI Shapefile",overwrite_layer=T)
```
